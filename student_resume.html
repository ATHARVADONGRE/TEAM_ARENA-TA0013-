{% extends "base.html" %}

{% block title %}Resume - Skill-Link{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><i class="fas fa-link"></i> Skill-Link</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/dashboard/student"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/dashboard/student/jobs"><i class="fas fa-briefcase"></i> Jobs</a></li>
                <li class="nav-item"><a class="nav-link" href="/dashboard/student/applications"><i class="fas fa-file-alt"></i> Applications</a></li>
                <li class="nav-item"><a class="nav-link active" href="/dashboard/student/resume"><i class="fas fa-upload"></i> Resume</a></li>
                <li class="nav-item"><a class="nav-link" href="/dashboard/student/skills"><i class="fas fa-tags"></i> Skills</a></li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="fas fa-user-graduate"></i> <span id="userName">Student</span></a>
                    <ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li></ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h5 class="mb-4"><i class="fas fa-upload text-primary me-2"></i>Upload Resume</h5>
                <div class="upload-area" id="uploadArea" style="border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer;">
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <p>Drag & drop your resume here or click to browse</p>
                    <p class="text-muted small">Supported: PDF, DOC, DOCX</p>
                    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" style="display: none;">
                </div>
                <div id="fileInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-info"><i class="fas fa-file-alt me-2"></i><span id="fileName"></span></div>
                </div>
                <button class="btn btn-primary w-100 mt-3" onclick="uploadResume()" id="uploadBtn">
                    <i class="fas fa-upload me-2"></i>Upload Resume
                </button>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h5 class="mb-4"><i class="fas fa-star text-warning me-2"></i>Resume Score</h5>
                <div class="text-center mb-4">
                    <div style="width: 120px; height: 120px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative;">
                        <svg style="position: absolute; transform: rotate(-90deg);" width="120" height="120">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#eee" stroke-width="10"/>
                            <circle cx="60" cy="60" r="50" fill="none" stroke="var(--primary)" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="314" id="scoreCircle"/>
                        </svg>
                        <span style="font-size: 32px; font-weight: bold; color: var(--primary);" id="scoreValue">0</span>
                    </div>
                </div>
                <div id="suggestions">
                    <p class="text-muted text-center">Upload your resume to get score and suggestions</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h5 class="mb-4"><i class="fas fa-file-alt text-info me-2"></i>Parsed Resume Data</h5>
                <div id="resumeData">
                    <p class="text-muted text-center">No resume uploaded yet</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area:hover { border-color: var(--primary) !important; background: #f8f9fa; }
</style>

<script>
var selectedFile = null;
var score = 0;

document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadResume();
});

function checkAuth() {
    var token = localStorage.getItem('token');
    if (!token || localStorage.getItem('userRole') !== 'student') {
        window.location.href = '/student/login';
    }
    var student = JSON.parse(localStorage.getItem('student') || '{}');
    document.getElementById('userName').textContent = student.name || 'Student';
}

document.getElementById('uploadArea').addEventListener('click', function() {
    document.getElementById('resumeFile').click();
});

document.getElementById('resumeFile').addEventListener('change', function(e) {
    if (this.files[0]) {
        selectedFile = this.files[0];
        document.getElementById('fileName').textContent = selectedFile.name;
        document.getElementById('fileInfo').style.display = 'block';
    }
});

async function uploadResume() {
    if (!selectedFile) { showNotification('Select a file first', 'warning'); return; }
    var token = localStorage.getItem('token');
    var formData = new FormData();
    formData.append('file', selectedFile);
    var btn = document.getElementById('uploadBtn');
    btn.disabled = true; 
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Uploading...';
    try {
        var response = await fetch('/api/resume/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
        });
        var data = await response.json();
        if (response.ok) {
            showNotification('Uploaded! Score: ' + data.score, 'success');
            score = data.score;
            document.getElementById('scoreValue').textContent = score;
            updateScoreCircle(score);
            loadResume();
        } else {
            showNotification(data.error || 'Failed', 'danger');
        }
    } catch (error) { showNotification('Error', 'danger'); }
    btn.disabled = false; 
    btn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Resume';
}

function updateScoreCircle(s) {
    var circle = document.getElementById('scoreCircle');
    var circumference = 314;
    var offset = circumference - (s / 100) * circumference;
    circle.style.strokeDashoffset = offset;
}

async function loadResume() {
    var token = localStorage.getItem('token');
    try {
        var scoreRes = await fetch('/api/resume/score', { headers: { 'Authorization': 'Bearer ' + token } });
        var dataRes = await fetch('/api/resume/data', { headers: { 'Authorization': 'Bearer ' + token } });
        
        if (scoreRes.ok) {
            var scoreData = await scoreRes.json();
            score = scoreData.score || 0;
            document.getElementById('scoreValue').textContent = score;
            updateScoreCircle(score);
            if (scoreData.suggestions && scoreData.suggestions.length > 0) {
                document.getElementById('suggestions').innerHTML = '<ul class="list-group">' + scoreData.suggestions.map(function(s) { return '<li class="list-group-item"><i class="fas fa-lightbulb text-warning me-2"></i>' + s + '</li>'; }).join('') + '</ul>';
            }
        }
        if (dataRes.ok) {
            var resumeData = await dataRes.json();
            if (resumeData.resume) {
                var r = resumeData.resume;
                var skills = r.skills || [];
                document.getElementById('resumeData').innerHTML = '<div class="row"><div class="col-md-6 mb-3"><h6><i class="fas fa-tools me-2"></i>Skills (' + skills.length + ')</h6><div>' + (skills.map(function(s) { return '<span class="skill-tag">' + s + '</span>'; }).join('') || 'None') + '</div></div><div class="col-md-6 mb-3"><h6><i class="fas fa-graduation-cap me-2"></i>Education</h6><p class="text-muted">' + (r.education || 'Not found') + '</p></div><div class="col-12"><h6><i class="fas fa-briefcase me-2"></i>Experience</h6><p class="text-muted">' + (r.experience || 'Fresher') + '</p></div></div>';
            }
        }
    } catch (error) { console.error('Error:', error); }
}

function logout() { localStorage.clear(); window.location.href = '/'; }
</script>
{% endblock %}
